input:
  redpanda:
    seed_brokers: ["redpanda:9092"]
    consumer_group: "influxdb_bridge_group"
    topics: ["^sensors\\..*\\..*\\.data$"]
    regexp_topics: true

pipeline:
  processors:
    - mapping: |
        let root = this
        
        let measurement = "sensor_data"
        let dev_id = $root.metadata.device_id.string().catch("0")
        let forest = $root.metadata.forest_area.string().catch("unknown")
        let quality = $root.metadata.data_quality_flag.string().catch("Good")

        let lat = $root.metadata.location.latitude.number().catch(0.0)
        let lon = $root.metadata.location.longitude.number().catch(0.0)
        let temp = $root.temperature.number().catch(0.0)
        let press = $root.air_pressure.number().catch(0.0)

        root = "%s,device_id=%s,forest_area=%s,quality=%s lat=%v,lon=%v,temperature=%v,pressure=%v".format(
          $measurement,
          $dev_id,
          $forest,
          $quality,
          $lat,
          $lon,
          $temp,
          $press
        )

    - log:
        level: INFO
        message: "VÃ‰RIFICATION FORMAT : ${! content() }"

output:
  http_client:
    url: "http://influxdb:8086/api/v2/write?org=iot-org&bucket=sensor-data&precision=s"
    verb: POST
    headers:
      Authorization: 'Token my-super-secret-auth-token'
      Content-Type: text/plain; charset=utf-8
